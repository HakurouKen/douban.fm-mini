!function(a,b){function c(){chrome.extension.sendRequest({action:"init"},function(b){b.init?setTimeout(function(){c()},1e3):(player=e.player,channel=e.channel,d(f(player).init(),player),a.ChannelUITest=g(channel).init(),h(ChannelUITest))})}function d(a,c){var d=new Component("body>.wrapper").init(),e=new Component("#hint").init();b.addEventListener("keydown",function(b){if("input"!==b.target.nodeName.toLowerCase())switch(b.keyCode){case 70:a.btn.heart.trigger();break;case 68:a.btn.trash.trigger();break;case 83:a.btn.next.trigger();break;case 66:a.btn.prev.trigger();break;case 32:"pause"===c.getState()?a.btn.resume.delegateTrigger():a.btn.pause.trigger();break;case 76:a.btn.loop.trigger();break;case 87:a.btn.download.trigger();break;case 37:c.jumpTo(c.getCurTime()-5);break;case 39:c.jumpTo(c.getCurTime()+5);break;case 38:c.volUp(5);break;case 40:c.volDown(5);break;case 72:d.toogleClass("blur"),e.toogleClass("hide")}})}var e=chrome.extension.getBackgroundPage();a.player={},a.channel={};var f=function(b){var c=new Component(".player").init(),d=new Component(".controller .time").init(),e=new Component(".play-progress").init(),f=new Component(".load-progress").init(),g=new Component("a.btn.heart",function(a,c){b.heart(c.toogleClass("hearted").hasClass("hearted")?!0:!1)}),h=new Component("a.btn.trash",function(){b.trash()}),i=new Component("a.btn.next",function(){b.next()}),j=new Component("a.btn.prev",function(){b.prev()}),k=new Component(".btn.pause",function(a){a.stopPropagation(),new Component(".player-container").init().addClass("paused"),b.pause()}),l=new Component("#fm-player-container"),m=new Component(".volume-wrapper",function(a,c){a.stopPropagation();var d=c.children(".volume"),e=(d.children(".current-volume"),a.clientX-d.pageOffset().left),f=e/d.width();b.vol(100*f)}),n=new Component("div.player-wrapper",function(a){var d=a.clientX-c.offset().left,e=d/c.width();b.jumpTo(100*e+"%")}),o=new Component(".cover",function(b,c){a.open(c.dom[0].getAttribute("data-album"))}),p=new Component(".loop",function(a,c){b.loop()?(b.loop(!1),c.removeClass("on").addClass("off").text("单曲循环：关")):(b.loop(!0),c.removeClass("off").addClass("on").text("单曲循环：开"))}),q=new Component(".download",function(a,b){a.preventDefault();var c=b.dom[0];c&&chrome.extension.sendRequest({action:"download",url:c.getAttribute("data-href"),name:c.title.replace("下载 : ","")+"."+(c.getAttribute("data-href").match(/\.\w+$/)||[""])[0].substr(1)},function(){})}),r=new Component(".cover img","load",function(a,c){var d=new Image,e=245,f=b.getSongInfo();d.src=f.picture.replace(/\/mpic\//,"/lpic/"),d.width/d.height>1.1?c.css("width",e+"px").css("height","auto"):d.height/d.width>1.1?c.css("height",e+"px").css("width","auto"):c.css("height",e+"px").css("width",e+"px")});return b.bind("timeupdate",function(){var a=b.getLength()-b.getCurTime(),f="-"+Math.floor(a/60)+":"+("0"+parseInt(a%60)).substr(-2);d.text(f),e.width(c.width()*b.getPlayingProgress())}),b.bind("progress",function(){f.width(c.width()*b.getLoadingProgress())}),b.bind("volumechange",function(){var a=new Component(".current-volume").init();a.css("width",b.vol()+"%")}),{btn:{heart:g.init("#fm-player-container"),trash:h.init("#fm-player-container"),next:i.init("#fm-player-container"),prev:j.init("#fm-player-container"),pause:k.init("#fm-player-container"),resume:l.init().delegate(".player-container.paused",function(a,c){c.removeClass("paused"),b.resume()}),volume:m.init("#fm-player-container"),progress:n.init("#fm-player-container"),cover:o.init("#fm-player-container"),loop:p.init("#fm-player-container"),download:q.init("#fm-player-container"),picture:r.init("#fm-player-container")},set:function(a,b,c){var d=Util.isString(a)?new Component(a).init("#fm-player-container"):a;return"text"===b?d.text(c):d.dom.forEach(function(a){a.setAttribute(b,c)}),this},refresh:function(){{var a=this,c=b.getSongInfo(),d=new Component(".player-container").init();/\/subject\//.test(c.album)?"http://music.douban.com"+c.album:c.album}return state=b.getState(),pic=c.picture.replace(/\/mpic\//,"/lpic/"),title=c.title+" - "+c.artist,title=title.length>25?title.slice(0,23)+"...":title,a.set("div.cover>img","src",pic),a.set("div.cover>img","alt",c.title),a.set(".cover","data-album","http://music.douban.com"+c.album),a.set(".infos .artist","text",c.artist),a.set(".infos .album-title","text","<"+c.albumtitle+">"),a.set(".infos .year","text",c.public_time),a.set(".infos .title-roller a","text",c.title),a.set(".infos .title-roller a","href","http://music.douban.com"+c.album),a.set(".download","text",title),a.set(".download","title","下载 : "+c.title+" - "+c.artist),a.set(".download","data-href",c.url),c.like&&new Component(".btn.heart").init().addClass("hearted"),"pause"===state?d.addClass("paused"):d.removeClass("paused"),a},init:function(){var a=this;return b.bind("loadstart",function(){a.refresh()}),a.refresh(),a}}},g=function(a){var c,d=new Component("#fm-channel-container").init(),e=new Component("#fm-channel").init("#fm-channel-container"),f=new Component("#search-result").init("#fm-channel-container"),g=(e.children('[data-area="system_chls"]'),function(){f.css("display","block"),e.css("display","none"),c.update()}),h=function(){e.css("display","block"),f.css("display","none"),c.update()},i=new Component("#fm-search form","submit",function(b,c){b.preventDefault();var d=Util.toArray(c.dom[0]),e={};d.forEach(function(a){"submit"!==a.type&&(e[a.name]=a.value)}),a.search(e,function(a){var b=Util.render("search-result-tpl",{keyword:e.keyword,result:a});f.html(b),g()})}),j=function(a){return e.children('[data-id="'+a+'"]>.channel').trigger()},k=function(a,b,d){var f,g=e.children('[data-area="'+b+'"]'),h=g.children('[data-id="'+a.id+'"]');return h.dom.length?(d&&j(a.id),h):(f=Util.render("single-channel-tpl",{info:a}),g.append(f),d&&j(a.id),c.update(),g.children('[data-id="'+a.id+'"]'))},l=function(a,b){var c='[data-id="'+a+'"]';return b&&(c='[data-area="'+b+'"] '+c),new Component(c).init().remove()},m=function(){return new Component('[data-id="'+a.getCurChannel()+'"]').init().addClass("playing")};return f.delegate(".return",function(){h()}).init(),e.delegate("li.channel-item>.channel",function(b,c){var d=c.parent(),f=d.dom[0]||{},g=f.getAttribute("data-id"),h=f.parentElement.getAttribute("data-area");e.children("li.channel-item.playing").removeClass("playing"),d.addClass("playing"),a.changeChannel(g,h)}),f.delegate(".channel-item",function(a,b){var c=b.dom[0],d={};d.name=c.dataset.name,d.id=c.dataset.cid,d.num=parseInt(c.dataset.songnum),d.intro=c.dataset.intro,k(d,"system_chls",!0)}),e.delegate("li.channel-item","mouseover",function(b,c){var d=c.dom[0],e=parseInt(d.dataset.id);return 0>=e?c:(a.isFav(e)?c.removeClass("unfav").addClass("fav"):c.removeClass("fav").addClass("unfav"),c)}),e.delegate("li.channel-item .opt",function(b,c){var d=c.parent(),e=c.dom[0].parentElement,f=e.dataset.id,g={id:f,name:e.dataset.name,intro:e.dataset.intro};d.hasClass("unfav")?a.fav(f,function(){k(g,"fav_chls"),m()}):d.hasClass("fav")&&a.unfav(f,function(){l(f,"fav_chls"),k(g,"system_chls"),m()}),d.toogleClass("fav").toogleClass("unfav")}),{event:{search:i.init("#fm-channel-container"),change:function(a){return j(a),this}},init:function(){return a.init(function(e){var f=e.sys.slice(0),g=a.getCurInfo(),h=[{area:"system_chls",channels:f},{title:"我的收藏",area:"fav_chls",channels:e.fav},{title:"热门歌曲",area:"recent_chls",channels:e.hot},{title:"上升最快",area:"recent_chls",channels:e.trend}];a.isMine(g.id)||f.push(g);var i=Util.render("channel-tpl",{playing:a.getCurChannel(),infos:h},!0),j=new Component("#fm-channel").init();j.html(i),c=tinyscrollbar(b.getElementById("fm-channel-container")),d.removeClass("preload")}),this},status:function(){return d.hasClass("off")?"off":"on"},on:function(){return d.removeClass("off"),this},off:function(){return d.addClass("off"),this},search:{on:function(){e.css("display","none"),f.css("display","block"),c.update()},off:function(){return e.css("display","block"),f.css("display","none"),c.update(),this}}}},h=function(a){new Component(".toogle",function(b,c){"on"===a.status()?(a.off(),c.removeClass("on")):(a.on(),c.addClass("on"))}).init();return{}};c()}(window,document);