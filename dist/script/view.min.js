!function(a,b){function c(){chrome.extension.sendRequest({action:"init"},function(a){a.init?setTimeout(function(){c()},1e3):(player=e.player,channel=e.channel,d(f(player).init(),player),h(g(channel).init()))})}function d(a,c){var d=new Component("body>.wrapper").init(),e=new Component("#hint").init();b.addEventListener("keydown",function(b){if("input"!==b.target.nodeName.toLowerCase())switch(b.keyCode){case 70:a.event.heart.trigger();break;case 68:a.event.trash.trigger();break;case 83:a.event.next.trigger();break;case 66:a.event.prev.trigger();break;case 32:"pause"===c.getState()?a.event.resume.delegateTrigger():a.event.pause.trigger();break;case 76:a.event.loop.trigger();break;case 87:a.event.download.trigger();break;case 37:c.jumpTo(c.getCurTime()-5);break;case 39:c.jumpTo(c.getCurTime()+5);break;case 38:c.volUp(5);break;case 40:c.volDown(5);break;case 72:d.toogleClass("blur"),e.toogleClass("hide")}})}var e=chrome.extension.getBackgroundPage();a.player={},a.channel={};var f=function(b){var c=new Component(".player").init(),d=new Component(".controller .time").init(),e=new Component(".play-progress").init(),f=new Component(".load-progress").init(),g=new Component("a.btn.heart",function(a,c){b.heart(c.toogleClass("hearted").hasClass("hearted")?!0:!1)}),h=new Component("a.btn.trash",function(){b.trash()}),i=new Component("a.btn.next",function(){b.next()}),j=new Component("a.btn.prev",function(){b.prev()}),k=new Component(".btn.pause",function(a){a.stopPropagation(),new Component(".player-container").init().addClass("paused"),b.pause()}),l=new Component("#fm-player-container"),m=new Component(".volume-wrapper",function(a,c){a.stopPropagation();var d=c.children(".volume"),e=(d.children(".current-volume"),a.clientX-d.pageOffset().left),f=e/d.width();b.vol(100*f)}),n=new Component("div.player-wrapper",function(a){var d=a.clientX-c.offset().left,e=d/c.width();b.jumpTo(100*e+"%")}),o=new Component(".cover",function(b,c){a.open(c.dom[0].getAttribute("data-album"))}),p=new Component(".loop",function(a,c){b.loop()?(b.loop(!1),c.removeClass("on").addClass("off").text("单曲循环：关")):(b.loop(!0),c.removeClass("off").addClass("on").text("单曲循环：开"))}),q=new Component(".download",function(a,b){a.preventDefault();var c=b.dom[0];c&&chrome.extension.sendRequest({action:"download",url:c.getAttribute("data-href"),name:c.title.replace("下载 : ","")+"."+(c.getAttribute("data-href").match(/\.\w+$/)||[""])[0].substr(1)},function(){})}),r=new Component(".cover img","load",function(a,c){var d=new Image,e=245,f=b.getSongInfo();d.src=f.picture.replace(/\/mpic\//,"/lpic/"),d.width/d.height>1.1?c.css("width",e+"px").css("height","auto"):d.height/d.width>1.1?c.css("height",e+"px").css("width","auto"):c.css("height",e+"px").css("width",e+"px")});return b.bind("timeupdate",function(){var a=b.getLength()-b.getCurTime(),f="-"+Math.floor(a/60)+":"+("0"+parseInt(a%60)).substr(-2);d.text(f),e.width(c.width()*b.getPlayingProgress())}),b.bind("progress",function(){f.width(c.width()*b.getLoadingProgress())}),b.bind("volumechange",function(){var a=new Component(".current-volume").init();a.css("width",b.vol()+"%")}),{event:{heart:g.init(),trash:h.init(),next:i.init(),prev:j.init(),pause:k.init(),resume:l.init().delegate(".player-container.paused",function(a,c){c.removeClass("paused"),b.resume()}),volume:m.init(),progress:n.init(),cover:o.init(),loop:p.init(),download:q.init(),picture:r.init()},set:function(a,b,c){var d=Util.isString(a)?new Component(a).init():a;return"text"===b?d.text(c):d.dom.forEach(function(a){a.setAttribute(b,c)}),this},refresh:function(){{var a=this,c=b.getSongInfo();/\/subject\//.test(c.album)?"http://music.douban.com"+c.album:c.album}return state=b.getState(),pic=c.picture.replace(/\/mpic\//,"/lpic/"),title=c.title+" - "+c.artist,title=title.length>25?title.slice(0,23)+"...":title,a.set("div.cover>img","src",pic),a.set("div.cover>img","alt",c.title),a.set(".cover","data-album","http://music.douban.com"+c.album),a.set(".infos .artist","text",c.artist),a.set(".infos .album-title","text","<"+c.albumtitle+">"),a.set(".infos .year","text",c.public_time),a.set(".infos .title-roller a","text",c.title),a.set(".infos .title-roller a","href","http://music.douban.com"+c.album),a.set(".download","text",title),a.set(".download","title","下载 : "+c.title+" - "+c.artist),a.set(".download","data-href",c.url),c.like&&new Component(".btn.heart").init().addClass("hearted"),"pause"===state&&new Component(".player-container").init().addClass("paused"),a},init:function(){var a=this;return b.bind("loadstart",function(){a.refresh()}),a.refresh(),a}}},g=function(a){var c=function(){a.init(function(c){var d=Util.render("channel-tpl",{playing:a.getCurChannel(),infos:[{area:"system_chls",channels:[{name:"我的私人兆赫",id:0},{name:"我的红心兆赫",id:-3}]},{title:"我的收藏",area:"fav_chls",channels:c}]},!0),e=new Component("#fm-channel-container").init();e.dom[0].innerHTML=d,tinyscrollbar(b.getElementById("fm-channel-container")),e.removeClass("preload")})},d=new Component("#fm-channel-container").init();return{event:{change:d.delegate("li.channel-item",function(b,c){var e=c.dom[0]||{},f=e.getAttribute("data-id"),g=e.parentElement.getAttribute("data-area");d.children("li.channel-item.playing").removeClass("playing"),c.addClass("playing"),a.changeChannel(f,g)})},init:function(){return c(),this},status:function(){return d.hasClass("off")?"off":"on"},on:function(){return d.removeClass("off"),this},off:function(){return d.addClass("off"),this}}},h=function(a){new Component(".toogle",function(b,c){"on"===a.status()?(a.off(),c.removeClass("on")):(a.on(),c.addClass("on"))}).init();return{}};c()}(window,document);